# Technical Specification: PolyWeather Minimal Dashboard (Vue 3 + Python)

**Version:** 0.2.0
**Scope:** Single-page, minimal, modern dashboard for Seoul (RKSI) daily high temperature market.

## 1. Goals
- Show **hourly actual** temperature for the current local day in Seoul.
- Show **real-time market prices** for today’s Seoul highest-temperature event (auto-detect slug).
- Fetch **personal data** (CLOB collateral balance and open positions) but do not display it in v2 UI.
- Keep UI minimal and readable; no trading actions in v2.

## 2. Architecture
### 2.1 Frontend
- **Framework:** Vue 3 (Vite build).
- **Layout:** single page with 2 panels: Weather and Market.
- **Polling:** every 30s for unified dashboard payload.
- **Charts:** line chart with a single series (Actual).
- **Dev Proxy:** Vite proxies `/api` to the local backend on port 3000.

### 2.2 Backend
- **Framework:** Python (FastAPI) as a thin proxy and aggregator.
- **Reasoning:** keeps API keys private, simplifies CORS, easy scheduled caching.
- **Security:** secrets stored in `.env`; never exposed to client.
- **CLOB Client:** use the official Polymarket Python CLOB client for authenticated balance.

## 3. Data Sources
### 3.1 Actuals (METAR)
- **Provider:** Aviation Weather Center.
- **Endpoint:** `https://aviationweather.gov/api/data/metar`
- **Parameters:** `ids=RKSI`, `format=json`, `hours=24`.
- **Companion source:** CheckWX decoded METARs (same station) for side-by-side validation.
  - **Endpoint:** `https://api.checkwx.com/metar/RKSI/decoded`
  - **Auth:** `X-API-Key` header.
  - **Decoded fields:** `observed` timestamp + `temperature.celsius`.

### 3.2 Market Data
- **Gamma API (event discovery):** `https://gamma-api.polymarket.com`
- **CLOB API (prices):** `https://clob.polymarket.com`
- **Data API (positions/activity):** `https://data-api.polymarket.com`

## 4. Event Auto-Detection
- Use **local date in Asia/Seoul** to compute slug:
  - `highest-temperature-in-seoul-on-{month}-{day}`
  - Month is lowercase full name (e.g., `january`), day is numeric (no zero padding).
- Flow:
  1) Build slug from KST date.
  2) Query Gamma event by slug (prefer `/events/slug/{slug}`; fallback to `/events?slug=...`).
  3) Extract `markets[]` and `clobTokenIds` from response.
  4) If missing, show "no event found" state and last successful slug.

## 5. Data Normalization
### 5.1 Time Axis (KST)
- All timestamps displayed in **Asia/Seoul**.
- Actual series aligned to **30-minute ticks** (00:00–23:30 local).

### 5.2 Actuals (METAR) to 30-Minute Buckets
- METAR observations are irregular; derive 30-minute actuals as:
  - For each 30-minute tick, use the **most recent METAR reading at or before** that tick.
  - If no reading exists for an hour, leave it null (gap in chart).
  - Hours after the current KST time should remain null.
  - Only readings from the current local day should be used.

### 5.3 Day High So Far
- Compute **max actual temperature since local 00:00** and display prominently.

## 6. Backend API (internal)
- `GET /api/dashboard`
  - Returns a single payload for the frontend containing:
    - `meta`: last refresh, KST date, slug.
    - `weather`: hourly actual arrays for both AWC + CheckWX and source comparison.
    - `market`: list of outcomes with Yes/No prices and recent volume.
    - `portfolio`: balance, positions.
  - Weather payload details:
    - `weather.hourly.times`: 48 half-hour ticks in KST.
    - `weather.hourly.awc`: 30-minute actuals from Aviation Weather Center.
    - `weather.hourly.checkwx`: 30-minute actuals from CheckWX.
    - `weather.sources`: latest/dayHigh per source plus `match` and `delta` for comparison.

### 6.1 External Requests (backend only)
- **Actuals:** METAR last 24h from Aviation Weather Center + CheckWX decoded METARs.
- **Market:** Gamma event -> CLOB prices by token id (Yes + No).
  - If CLOB price is missing or zero, fallback to Gamma `bestAsk` (then `lastTradePrice`).
  - Include `volume24hr` from Gamma when available.
- **Portfolio:** CLOB balance + Data API positions.

### 6.2 Caching
- In-memory cache with **TTL 25–30s** to avoid rate limits.
- Cache keys: `metar`, `metar:awc`, `metar:checkwx`, `event`, `prices`, `portfolio`.
- CheckWX usage notes:
  - Free plan includes **3,000 daily requests** (10 METAR endpoints); daily counter resets at **00:00 UTC**.
  - 30s polling ≈ **2,880 requests/day**, within the free plan budget.
  - CheckWX recommends caching METAR/TAF responses for **at least 15 minutes** and returns **429** when daily limits are exceeded.

## 7. Portfolio Data
- **Balance:** CLOB collateral balance (USDC) via authenticated CLOB request.
- **Positions:** Data API `GET /positions?user=...`.

## 8. UI Layout (Minimal)
- **Header:**
  - Title: “Seoul Daily High (RKSI)”
  - Current KST date
  - Last refresh time
  - Day high so far
- **Weather panel:**
  - Line chart: Actual (AWC + CheckWX) with hover tooltip (time + temperature) and labeled axes.
  - Small legend showing both sources and whether they match.
- **Market panel:**
  - Table of outcomes: label, Yes/No prices; highlight outcome matching day high so far
- **Portfolio panel:** not shown in v2 UI (data still available in payload).

## 9. Configuration (.env)
- `SEOUL_TIMEZONE=Asia/Seoul`
- `MARKET_SLUG_PREFIX=highest-temperature-in-seoul-on`
- `CHECK_WX_API_KEY`
- `CHECK_WX_HOST=https://api.checkwx.com`
- `CHECK_WX_TTL_SECONDS=30`
- `POLYMARKET_USER_ADDRESS`
- `POLYMARKET_PRIVATE_KEY`
- `POLYMARKET_API_KEY`
- `POLYMARKET_API_SECRET`
- `POLYMARKET_API_PASSPHRASE`
- `POLYMARKET_SIGNATURE_TYPE=1`
- `POLYMARKET_FUNDER_ADDRESS`
- `POLYMARKET_CHAIN_ID=137`
- `CACHE_TTL_SECONDS=30`
- `PORT=3000`

## 10. Security
- Secrets never sent to browser.
- Backend only performs authenticated calls.
- Frontend only hits `/api/dashboard`.
- For Google/Magic login, use proxy wallet auth (signature type `1`) and set `POLYMARKET_FUNDER_ADDRESS` to the proxy wallet address shown on Polymarket.

## 11. Non-Goals (v2)
- No order placement or trading actions.
- No multi-city support.
- No mobile app.

## 12. Open Questions
- None.
